<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGarageApp - Backyard Mechanic's Assistant</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary: #d32f2f;
            --dark: #212121;
            --light: #f5f5f5;
            --accent: #ffa000;
            --success: #2e7d32;
            --info: #0288d1;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light);
            margin: 0; padding: 0;
            color: var(--dark);
        }

        header {
            background-color: var(--dark);
            color: white;
            padding: 1rem;
            text-align: center;
            border-bottom: 4px solid var(--primary);
        }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); text-transform: uppercase; }

        input, textarea, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 16px;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        .secondary-btn { background-color: var(--dark); }
        .export-btn { background-color: var(--success); }
        .web-btn { background-color: var(--info); }

        .garage-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin: 15px 0; 
        }

        .vehicle-chip {
            background: #e0e0e0;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .vehicle-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--dark);
        }

        .chip-delete {
            font-size: 18px;
            color: #b71c1c;
            padding: 0 5px;
        }

        .hidden-section { display: none; }

        .dropdown-container {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .dropdown-header {
            background: #eee;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .dropdown-content {
            display: none;
            padding: 10px;
            background: white;
        }

        .dropdown-content.show { display: block; }

        .log-entry {
            background: #f9f9f9; padding: 12px; border-left: 4px solid var(--primary);
            margin-top: 10px; border-radius: 4px; border: 1px solid #ddd;
        }

        .reminder-box {
            background: #f1f8e9; border: 1px solid #81c784; padding: 12px;
            border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;
            text-align: center;
        }

        /* SCREENSHOT GALLERY STYLES */
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .screenshot-grid img {
            width: 100%;
            height: auto;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }

        .screenshot-grid img:hover {
            transform: scale(1.05);
        }

        /* Lightbox for viewing full size */
        #lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            border: 3px solid white;
        }
    </style>
</head>
<body>

<header>
    <h1>MyGarageApp</h1>
    <p style="margin:0; font-size: 0.8rem; color: #aaa;">Fleet Maintenance & Diagnostic Assistant</p>
</header>

<div class="container">
    
    <div class="card">
        <h2>My Garage</h2>
        <input type="text" id="vehicleInput" placeholder="Enter Vehicle (e.g. 2004 F-150)">
        <button onclick="addNewVehicle()" class="secondary-btn">Add New Vehicle</button>
        <div class="garage-list" id="garageList"></div>
    </div>

    <div class="card">
        <h2>Project Gallery</h2>
        <div class="screenshot-grid">
            <img src="screenshot1.png" alt="Screenshot 1" onclick="openLightbox(this.src)">
            <img src="screenshot2.png" alt="Screenshot 2" onclick="openLightbox(this.src)">
            <img src="screenshot3.png" alt="Screenshot 3" onclick="openLightbox(this.src)">
        </div>
    </div>

    <div id="activeVehicleSection" class="hidden-section">
        
        <div id="reminderDisplay"></div>

        <div class="card">
            <h2 id="diagTitle">Diagnose</h2>
            <input type="text" id="diagInput" placeholder="Symptom or OBD Code">
            <button onclick="diagnoseProblem()">Search Fixes</button>
            <div id="diagResult" style="display:none; padding:10px; background:#e1f5fe; border-left:4px solid var(--info); margin-top:10px;"></div>
            
            <div id="internetSection" style="display:none; margin-top:10px;">
                <button class="web-btn" onclick="searchInternet()">Search Internet</button>
                <textarea id="internetFixInput" placeholder="Paste Internet fix here..." style="margin-top:10px;"></textarea>
                <button onclick="saveInternetFix()" style="background-color: var(--success);">Save to Library</button>
            </div>

            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown('savedFixesList', 'fixArrow')">
                    <span>Saved Diagnostic Fixes</span>
                    <span id="fixArrow">‚ñº</span>
                </div>
                <div id="savedFixesList" class="dropdown-content"></div>
            </div>
        </div>

        <div class="card">
            <h2>New Service Entry</h2>
            <input type="date" id="logDate">
            <input type="number" id="logMiles" placeholder="Mileage">
            <textarea id="logTask" placeholder="Service performed..."></textarea>
            <button onclick="saveLog()">Save Record</button>
            
            <div class="dropdown-container">
                <div class="dropdown-header" onclick="toggleDropdown('logHistoryList', 'logArrow')">
                    <span>Maintenance Log History</span>
                    <span id="logArrow">‚ñº</span>
                </div>
                <div id="logHistoryList" class="dropdown-content">
                    <div id="logDisplay" style="max-height: 400px; overflow-y: auto;"></div>
                    <button onclick="downloadHistory()" class="export-btn" style="margin-top:15px;">Download History (.txt)</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg" src="">
</div>

<script>
    let currentVehicle = "";

    window.onload = function() {
        refreshGarage();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    };

    // LIGHTBOX FUNCTIONS
    function openLightbox(src) {
        document.getElementById('lightboxImg').src = src;
        document.getElementById('lightbox').style.display = 'flex';
    }

    function addNewVehicle() {
        const name = document.getElementById('vehicleInput').value.trim();
        if (!name) return;
        let garage = JSON.parse(localStorage.getItem('myGarage')) || [];
        if (!garage.includes(name)) {
            garage.push(name);
            localStorage.setItem('myGarage', JSON.stringify(garage));
        }
        document.getElementById('vehicleInput').value = "";
        refreshGarage();
        selectVehicle(name);
    }

    function refreshGarage() {
        const list = document.getElementById('garageList');
        list.innerHTML = "";
        let garage = JSON.parse(localStorage.getItem('myGarage')) || [];
        garage.forEach(veh => {
            const chip = document.createElement('div');
            chip.className = `vehicle-chip ${veh === currentVehicle ? 'active' : ''}`;
            chip.innerHTML = `
                <span onclick="selectVehicle('${veh}')">üöó ${veh}</span>
                <span class="chip-delete" onclick="deleteVehicle('${veh}', event)">‚úï</span>
            `;
            list.appendChild(chip);
        });
    }

    function selectVehicle(name) {
        currentVehicle = name;
        document.getElementById('activeVehicleSection').style.display = 'block';
        document.getElementById('diagTitle').innerText = "Diagnose: " + name;
        document.getElementById('savedFixesList').classList.remove('show');
        document.getElementById('logHistoryList').classList.remove('show');
        refreshGarage();
        refreshLogDisplay();
        updateReminders();
        loadSavedFixes();
    }

    function toggleDropdown(listId, arrowId) {
        const content = document.getElementById(listId);
        content.classList.toggle('show');
        document.getElementById(arrowId).innerText = content.classList.contains('show') ? "‚ñ≤" : "‚ñº";
    }

    function loadSavedFixes() {
        const list = document.getElementById('savedFixesList');
        list.innerHTML = "";
        let saved = JSON.parse(localStorage.getItem('internetFixes')) || {};
        const keys = Object.keys(saved);
        if (keys.length === 0) {
            list.innerHTML = "<p style='font-size:0.8rem; color:#888;'>No saved fixes.</p>";
            return;
        }
        keys.forEach(key => {
            const div = document.createElement('div');
            div.className = "log-entry";
            div.style.borderLeftColor = "var(--info)";
            div.innerHTML = `<strong>Issue: ${key}</strong><p style="font-size:0.85rem;">${saved[key]}</p><button style="width:auto; background:#b71c1c; font-size:11px; padding:4px 8px;" onclick="deleteFix('${key}')">Delete</button>`;
            list.appendChild(div);
        });
    }

    function deleteFix(key) {
        if (!confirm(`Delete fix for ${key}?`)) return;
        let saved = JSON.parse(localStorage.getItem('internetFixes')) || {};
        delete saved[key];
        localStorage.setItem('internetFixes', JSON.stringify(saved));
        loadSavedFixes();
    }

    function deleteVehicle(name, event) {
        event.stopPropagation();
        if (!confirm(`Delete ${name}?`)) return;
        let garage = JSON.parse(localStorage.getItem('myGarage')) || [];
        localStorage.setItem('myGarage', JSON.stringify(garage.filter(v => v !== name)));
        if (currentVehicle === name) {
            currentVehicle = "";
            document.getElementById('activeVehicleSection').style.display = 'none';
        }
        refreshGarage();
    }

    function diagnoseProblem() {
        const input = document.getElementById('diagInput').value.toUpperCase().trim();
        const res = document.getElementById('diagResult');
        const internet = document.getElementById('internetSection');
        if (!input) return;
        let saved = JSON.parse(localStorage.getItem('internetFixes')) || {};
        let fix = saved[input] || (input === "SHAKING" ? "Check balance/rotors." : null);
        res.style.display = "block";
        if (fix) {
            res.innerHTML = `<b>Fix Found:</b><br>${fix}`;
            internet.style.display = "none";
        } else {
            res.innerHTML = "Not found locally.";
            internet.style.display = "block";
        }
    }

    function searchInternet() {
        window.open(`https://www.google.com/search?q=${currentVehicle} ${document.getElementById('diagInput').value} fix`, '_blank');
    }

    function saveInternetFix() {
        const q = document.getElementById('diagInput').value.toUpperCase().trim();
        const txt = document.getElementById('internetFixInput').value;
        if (!q || !txt) return alert("Enter problem and fix.");
        let saved = JSON.parse(localStorage.getItem('internetFixes')) || {};
        saved[q] = txt;
        localStorage.setItem('internetFixes', JSON.stringify(saved));
        document.getElementById('internetFixInput').value = "";
        diagnoseProblem();
        loadSavedFixes();
    }

    function saveLog() {
        const date = document.getElementById('logDate').value;
        const miles = parseInt(document.getElementById('logMiles').value) || 0;
        const task = document.getElementById('logTask').value;
        if (!date || !task) return alert("Fill in date and task.");
        let allLogs = JSON.parse(localStorage.getItem('vehicleLogs')) || {};
        if (!allLogs[currentVehicle]) allLogs[currentVehicle] = [];
        allLogs[currentVehicle].push({ date, miles, task });
        localStorage.setItem('vehicleLogs', JSON.stringify(allLogs));
        document.getElementById('logDate').value = "";
        document.getElementById('logMiles').value = "";
        document.getElementById('logTask').value = "";
        refreshLogDisplay();
        updateReminders();
    }

    function refreshLogDisplay() {
        const display = document.getElementById('logDisplay');
        display.innerHTML = "";
        let allLogs = JSON.parse(localStorage.getItem('vehicleLogs')) || {};
        let logs = allLogs[currentVehicle] || [];
        if (logs.length === 0) { display.innerHTML = "<p style='font-size:0.8rem; color:#888;'>No service history.</p>"; return; }
        [...logs].reverse().forEach((entry, idx) => {
            const realIdx = logs.length - 1 - idx;
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerHTML = `<strong>${entry.date}</strong> | ${entry.miles} mi<br>${entry.task}<br><button style="width:auto; background:#b71c1c; font-size:11px; margin-top:5px; padding:4px 8px;" onclick="deleteEntry(${realIdx})">Delete</button>`;
            display.appendChild(div);
        });
    }

    function deleteEntry(index) {
        if (!confirm("Delete record?")) return;
        let allLogs = JSON.parse(localStorage.getItem('vehicleLogs')) || {};
        allLogs[currentVehicle].splice(index, 1);
        localStorage.setItem('vehicleLogs', JSON.stringify(allLogs));
        refreshLogDisplay();
        updateReminders();
    }

    function updateReminders() {
        const display = document.getElementById('reminderDisplay');
        let allLogs = JSON.parse(localStorage.getItem('vehicleLogs')) || {};
        let logs = allLogs[currentVehicle] || [];
        let lastOil = [...logs].reverse().find(l => l.task.toLowerCase().includes("oil"));
        let latestMiles = logs.length ? Math.max(...logs.map(l => l.miles)) : 0;
        if (lastOil) {
            let nextOil = lastOil.miles + 5000;
            let diff = nextOil - latestMiles;
            display.innerHTML = `<div class="reminder-box">üõ¢Ô∏è <b>Oil Change:</b> Next at ${nextOil} mi (${diff > 0 ? diff + ' mi left' : 'OVERDUE!'})</div>`;
        } else { display.innerHTML = ""; }
    }

    function downloadHistory() {
        let allLogs = JSON.parse(localStorage.getItem('vehicleLogs')) || {};
        let logs = allLogs[currentVehicle] || [];
        let txt = `MYGARAGEAPP HISTORY: ${currentVehicle}\n\n` + logs.map(e => `${e.date} | ${e.miles} mi | ${e.task}`).join("\n");
        const blob = new Blob([txt], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${currentVehicle}_Log.txt`;
        a.click();
    }
</script>

</body>
</html>